version: '3.8'

services:
  traefik:
      image: traefik:v2.9.8
      container_name: router_traefik
      ports:
          - "80:80"
          - "443:443"
      volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - ./services/traefik/traefik.toml:/etc/traefik/traefik.toml
          - ./acme.json:/acme.json

  platzi_fastapi:
      container_name: platzi_fastapi
      build:
        context: ./services/platzi_fastapi_sql
      command: ["./scripts/wait-for-it.sh", "pgsql_farm:5432", "--", "uvicorn", "main:api", "--host", "0.0.0.0", "--port", "8082"]
      restart: always
      labels:
          - "traefik.enable=true"
          - "traefik.http.routers.platzi.rule=Host(`${PLATZI_DOMAIN}`)"
          - "traefik.http.services.platzi.loadbalancer.server.port=${PLATZI_PORT}"
          - "traefik.http.routers.platzi.entrypoints=websecure"
          - "traefik.http.routers.platzi.tls.certresolver=letsencrypt"
      environment:
          - TZ=America/Bogota
          - API_VERSION=${PLATZI_VERSION}
          - DB_URL=postgresql://${DB_USER}:${DB_PASS}@pgsql_farm:${DB_PORT}/${DB_NAME_PLATZI}

  pgsql_farm:
      image: postgres:15.2
      container_name: pgsql_farm
      restart: always
      volumes:
          - db_farm:/var/lib/postgresql/data/
          - ./scripts/db-init_sql.sh:/docker-entrypoint-initdb.d/db-init_sql.sh
      expose:
          - ${DB_PORT}
      environment:
          - POSTGRES_PASSWORD=${DB_PASS}
          - POSTGRES_USER=${DB_USER}
          # Databases
          - FARM_DB=${DB_NAME_FARM}
          - PLATZI_DB=${DB_NAME_PLATZI}

volumes:
    db_farm:       
